// Define a basic user entity
entity user {
  key name: text;
  mutable balance: integer;
}

entity user_balance_last_updated {
  key user;
  mutable last_updated: timestamp;
}

// Define an extendable function that will be called when the user is updated
@extendable function user_updated(user);

// This function triggers the extendable function
function update_balance(user) {
  user.balance += 100;
  user_updated(user);
}

// This function gets run whenever the user is updated
@extend(user_updated) 
function log_user_update(user) {
  log("User updated: " + user.name + " with balance: " + user.balance);
}

// This also gets run whenever the user is updated
@extend(user_updated)
function update_total_balance(user) {
  update user_balance_last_updated @ { user } (op_context.last_block_time);
}